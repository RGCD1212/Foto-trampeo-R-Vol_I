---
output:
  pdf_document: default
  html_document: default
---


# Inter/extrapolación de la diversidad: `iNEXT`

### *Julio C. Hernández-Hernández* {-}

## Introducción

Considerando las dificultades que surgen al intentar comparar los distintos índices de diversidad porque difieren significativamente en sus unidades (e.g. índice de Simpson, índice de Shannon-Wiener), @hill1973diversity sugiere realizar transformaciones matemáticas a los índices antes propuestos y presenta la denominada serie de Números de diversidad de Hill o número efectivo de especies. 

Los números de diversidad de Hill se han utilizado cada vez más para cuantificar la diversidad taxonómica/especies de un conjunto, debido a que representan una alternativa estadísticamente rigurosa en comparación a otros índices de diversidad. Para mayor detalle ver @hill1973diversity y @chao2014unifying. 

El objetivo de este capítulo es presentar un análisis de los números de diversidad de Hill con el paquete R `iNEXT` por @hsieh2016inext. El nombre del paquete se debe a los principales análisis que realiza: *iNterpolación* y *EXTrapolación*. Este paquete proporciona funciones simples para calcular y graficar curvas de muestreo basadas en el tamaño de la muestra, cobertura y datos de abundancia e incidencia. 

## Diversidad Hill

Los números de diversidad de Hill están parametrizados por un orden de diversidad `q` que determina la sensibilidad de las medidas a las abundancias relativas de las especies, los cuales incluyen tres medidas de diversidad de especies:

- Diversidad del orden 0, (q = 0). Da el mismo peso a todas las especies (riqueza de especies).

- Diversidad del orden 1, (q = 1). Da más peso a las especies comunes (diversidad de Shannon).

- Diversidad del orden 2, (q = 2). Da más peso a las especies abundantes (diversidad de Simpson).

Por otra parte, la completitud del inventario se evalúa mediante la cobertura de la muestra, que mide la proporción del número total de individuos en una comunidad que pertenece a las especies representadas en la muestra [@chao2012coverage]. 

## Fuciones de `iNEXT` 

El paquete `iNEXT` está disponible en: <https://cran.r-project.org/web/packages/iNEXT/index.html>. Las principales funciones se muestran en el Cuadro (\@ref(tab:x1)).

```{r x1, echo=FALSE, message=FALSE, warning=FALSE}
library(kableExtra)
library(xtable)
tabla_1 <- read.csv(file = "tabla_1.csv", header = TRUE, sep = ",")
knitr::kable(tabla_1, caption = "Principales funciones del paquete iNEXT.") %>% kable_styling(font_size = 7)
```

Se cargan los siguientes paquetes:

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(iNEXT)
library(ggplot2)
```

Se emplea la siguiente función para preparar los datos:

```
iNEXT(x, q, datatype, size, endpoint, knots, se, 
      conf = 0.95, nboot = 50)
```

Los argumentos de esta función se describen a continuación y se explicarán posteriormente con más detalle mediante ejemplos ilustrativos: 

- `x`: Matriz, data.frame, lista de abundancias/incidencias de especies, o lista de frecuencias de incidencia,

- `q`: Número o vector que especifica los órdenes de diversidad de los números de Hill (0, 1, 2),

- `Datatype`: Tipo de datos de entrada: `abundance`, `incidencia` _freq` o `incidencia_raw`,

- `Size`: Vector entero del tamaño de muestra para el cual se calcularán las estimaciones de diversidad. Si es `NULL`, las estimaciones de diversidad se calcularán para los tamaños de muestra determinados por el valor especificado de `endpoint` y `knots`.

- `endpoint`: Número entero que especifica el tamaño de muestra para el cálculo de - Rarefaction/Extrapolation. Si es `NULL`, entonces el `endpoint = double` del tamaño de la muestra de referencia,

- `Knots`: Un número entero que especifica el número de `Knots` igualmente espaciados (40, por defecto) entre el tamaño 1 y el punto final (`endpoint`).

- `se`: Variable lógica para calcular el error estándar y el intervalo de confianza de un nivel especificado por `conf`.

- `conf`: Número positivo < 1 que especifica el nivel de intervalo de confianza.

- nboot,Un entero que especifica el número de repeticiones de bootstrap (remuestreo).

## Formato de datos

El paquete `iNEXT` permite emplear dos tipos de datos. 

Los datos para cada conjunto / sitio incluyen abundancias de especies de muestra en una muestra empírica de individuos (una muestra de referencia).

1. Datos de abundancia basados en individuos (`datatype = abundance`):  Los datos de entrada para cada ensamblaje/sitio incluyen muestras de abundancias de especies en una muestra empírica de individuos ("muestra de referencia").

2. Datos de incidencia basados en unidades de muestreo: para cada conjunto / sitio, los datos para una muestra de referencia consisten en presencia / ausencia de especie (o detección / no detección) en cada una de las unidades de muestreo múltiples.

3. Datos de incidencia basados en unidades de muestreo:

  - Datos de incidencia-frecuencia (`datatype = incidence` _freq`): los datos de entrada para cada conjunto/sitio consisten en frecuencias de incidencia de muestras de especies (sumas de filas de cada matriz de incidencia). La primera entrada de cada lista debe ser el número total de unidades de muestreo, seguido de las frecuencias de incidencia de las especies.

  - Datos crudos de incidencia (`datatype = incidence_raw`): para cada conjunto/sitio, los datos consisten en presencia/ausencia de especie (detección/ no detección) en cada una de las unidades de muestreo. 

## Ejemplos de rarefacción/extrapolación

### Datos de abundancia 

```{r x3, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
base_1 <- read.csv(file = "base_1.csv", header = TRUE)
knitr::kable(base_1, caption = "Ejemplo de datos número de observaciones independientes en dos sitios o cámaras-trampa.")
```

Se cargan los datos como:

```{r echo=TRUE, message=FALSE, warning=FALSE}
curva_abundancia <- read.table(file = 
          "datos_abundancia.csv", header = TRUE, 
          sep = ",")
```

En el Cuadro (\@ref(tab:x3)) se ejemplifican estos datos. Se elimina la columna `Especie` para trabajar con las variables `Sitio_1` y `Sitio_2`:

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=TRUE}
curva_abundancia <- (curva_abundancia[,2:3])
```

Se da valor a la extrapolación (e.g. doble del número de inviduos registrados):

```{r echo=TRUE, message=FALSE, warning=FALSE}
t <- seq (1,600)
```

Luego se ejecuta el análisis y se crea un objeto:

```{r echo=TRUE, message=FALSE, warning=FALSE, linewidth=55}
iNEXT(curva_abundancia, q = 0, datatype = "abundance", 
      size = t)
curva_abundance <- iNEXT(curva_abundancia, q = 0, 
      datatype = "abundance", size = t)
```

### Interpretación de resultados

`$DataInfo`: Muestra información básica de los datos. Nombre de los sitios (`site`), tamaño de muestra de referencia (`n`), riqueza de especies observada (`S.obs`), estimado de la cobertura de la muestra (`SC`) y los primeros diez recuentos de frecuencia (`f1-f10`), donde `f1` denota el número de especies representadas por un individuo (`singletons`), `f2` denota el número de especies representadas por dos individuos (`doubletons`), y `fk` denota el número de especies representadas por exactamente `k` individuos.

`$iNextEst`: Diversidad estimada con muestras rarificadas y extrapoladas para ambos sitios.

`Method`: interpolado, observado o extrapolado , dependiendo de si el tamaño m es menor, igual o mayor que el tamaño de muestra de referencia.

`Order`: Estimación de diversidad de orden q (qD). 95% (default) de límite de confianza superior e inferior de diversidad (qD.LCL, qD.UCL), y la estimación de cobertura de la muestra (SC) junto con los límites de confianza superior e inferior del 95% (default) de la cobertura de muestra (SC.LCL, SC.UCL). Estas estimaciones de cobertura de muestra con intervalos de confianza se utilizan para trazar las curvas de R/E y la cobertura de la muestra. 

`$AsyEst`: Estimaciones de diversidad asintótica junto con estadísticas relacionadas. Enumera la diversidad observada, estimaciones asintóticas, bootstrap estimado, s.e. y los intervalos de confianza para números de Hill del orden q = 0, 1 y 2. Las asíntotas estimadas se calculan a través de la función ChaoRichness () para q = 0, ChaoShannon () para q = 1 y ChaoSimpson () para q = 2; para mayor detalle ver Chao et al. (2014) para las fórmulas de estos estimadores asintóticos. 

### Gráficos

La función `ggiNEXT()` funciona como una extensión del paquete `ggplot2` para crear curvas de R/E usando una sola línea de código. Tres tipos de curvas son compatibles:

1. Basada en el tamaño de muestra (`type = 1`). Representa las estimaciones de diversidad con intervalos de confianza (si `se=TRUE`) como una función del tamaño de muestra hasta el doble del tamaño de muestra por `default`, o un `endpoint` especificado por el usuario (Figura \@ref(fig:f1)).

```{r f1, echo=TRUE, fig.align='center', fig.cap="Gráfico de interpolación.", message=FALSE, warning=FALSE, out.width="85%"}
ggiNEXT(curva_abundance, type = 1, se = TRUE, 
  color.var = "site",grey = FALSE) + 
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom", 
        text = element_text(size = 12), 
        legend.title = element_blank()) + 
  labs (x = "Número de individuos", 
        y = "Diversidad de especies")
```

2. Curva de cobertura de la muestra o completitud del muestreo (`type = 2`). Con intervalos de confianza (si `se=TRUE`). Esta curva traza la cobertura de muestra con respecto al tamaño de la muestra para el mismo rango descrito en el `type 1` (Figura \@ref(fig:f2)).

```{r f2, echo=TRUE, fig.align='center', fig.cap="Gráfico de interpolación.", message=FALSE, warning=FALSE, out.width="85%"}
ggiNEXT(curva_abundance, type = 2, se = TRUE, 
  color.var = "site", grey = FALSE) + 
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom", 
        text = element_text(size = 12), 
        legend.title = element_blank()) + 
  labs (x = "Número de individuos", 
        y = "Cobertura de la muestra")
```

3. Curva de R/E basada en la cobertura de la muestra (`type = 3`). Se grafica las estimaciones de diversidad con intervalos de confianza (si `se = TRUE`) como una función de la cobertura de la muestra hasta la cobertura máxima obtenida del tamaño máximo descrito en el `type 1`. Los gráficos señalan con símbolos las muestras de referencia (círculo: sitio 1; triángulo: sitio 2). La zona sombreada señala los intervalos de confianza al 95%. La extrapolación se extiende hasta el doble del número de individuos registrados (Figura \@ref(fig:f3)).

```{r f3, echo=FALSE, fig.align='center', fig.cap="Gráfico de interpolación.", message=FALSE, warning=FALSE, out.width="85%"}
ggiNEXT(curva_abundance, type = 3, se = TRUE, 
  color.var = "site", grey = FALSE) + 
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom",
        text = element_text(size = 12), 
        legend.title = element_blank()) + 
  labs (x = "Cobertura de la muestra", 
      y = "Diversidad de especies")
```

### Datos de incidencia-frecuencia 

Se carga la base de datos:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.align='center'}
curva_incidencia <- read.table(file = 
    "datos_incidencia.csv", header = TRUE, sep = ",")
base_2 <- read.csv(file = "base_2.csv", header = TRUE)
knitr::kable(base_2)
```

Se elimina la columna `Especie` para trabajar con las variables `Sitio 1` y `Sitio 2`; se le da valor a la extrapolación (e.g. doble del número de unidades de muestreo); y se ejecuta el análisis y se crea un objeto (Figura \@ref(fig:f4) a 6.6).

```{r message=FALSE, warning=FALSE, include=FALSE, linewidth=45}
curva_incidencia <- (curva_incidencia[,2:3])
t <- seq (1,700)
iNEXT(curva_incidencia, q = 0, 
      datatype = "incidence_freq", size = t)
curva_incidence <- iNEXT(curva_incidencia, q = 0, 
                 datatype = "incidence_freq", size = t)
```

```{r f4, echo=FALSE, fig.align='center', fig.cap="Gráfico de interpolación.", message=FALSE, warning=FALSE, out.width="85%"}

ggiNEXT(curva_incidence, type = 1, se = TRUE, 
        color.var = "site", grey = FALSE) + 
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom", 
        text = element_text(size = 12), 
        legend.title = element_blank()) + 
labs (x = "Unidades de muestreo", 
      y = "Diversidad de especies")
```


```{r f5, echo=FALSE, fig.align='center', fig.cap="Gráfico de interpolación.", message=FALSE, warning=FALSE, out.width="85%"}
ggiNEXT(curva_incidence, type = 2, se = TRUE, 
        color.var = "site", grey = FALSE) + 
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom", 
        text = element_text(size = 12), 
        legend.title = element_blank()) + 
labs (x = "Unidades de muestreo", 
      y = "Diversidad de especies")
```


```{r f6, echo=FALSE, fig.align='center', fig.cap="Gráfico de interpolación.", message=FALSE, warning=FALSE, out.width="85%"}

ggiNEXT(curva_incidence, type = 3, se = TRUE, 
        color.var = "site", grey = FALSE) + 
  theme_classic(base_size = 12) + 
  theme(legend.position = "bottom", 
        text = element_text(size = 12), 
        legend.title = element_blank()) + 
  labs (x = "Unidades de muestreo", 
        y = "Diversidad de especies")
```

## Sumario

Se han desarrollado varios métodos para estimar el número real de especies en una muestra incompleta y para evaluar la integridad del inventario. Estos métodos se pueden dividir en dos grandes clases: estimadores de riqueza de especies basados en la extrapolación de curvas de acumulación de especies y estimadores no paramétricos relacionados con modelos de captura-recaptura. Estos últimos suelen tener un mejor desempeño en estudios comparativos. Los ejemplos presentados en este trabajo son una opción de análisis para este propósito.  



