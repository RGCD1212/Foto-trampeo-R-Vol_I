---
title: "Memorias del Curso/Taller"
subtitle: "Foto-trampeo en R"

date: "Versión: `r format(Sys.time())`"

# Tipo de documento:
output: 
  bookdown::pdf_book:
    keep_tex: yes
    latex_engine: xelatex
    citation_package: natbib
site: bookdown::bookdown_site
documentclass: book
highlight: kate  
classoption: a5paper

# Encabezado de cada página:
header-includes:
   - \usepackage[utf8]{inputenc}
   - \usepackage[spanish]{babel}
   - \usepackage{fancyhdr}
   - \pagestyle{fancy}
   - \fancyhf{}
   - \fancyhead[LO]{\textit{\small{\nouppercase{\leftmark}}}}
   - \fancyhead[RE]{\textit{\small{\nouppercase{\rightmark}}}}
   - \fancyhead[RO,LE]{\thepage}

# Formato general:   
fontsize: 10.5pt
linestretch: 1
toc-depth: 2
secnumdepth: 1
lof: False
lot: False
geometry: "left=2.5cm, right=2cm, top=2.5cm, bottom=2.5cm"
#geometry: "left=2cm, right=1.7cm, top=2.5cm, bottom=2.5cm"

---

# Interacciones fruto-mamífero: varios paquetes

### *Angela A. Camargo-Sanabria y Carlos M. Delgado-Martínez* {-}

## Introducción

Los mamíferos herbívoros afectan de manera significativa los patrones de supervivencia, reclutamiento y densidad de las poblaciones de plantas en las selvas húmedas tropicales [@Camargo-Sanabria2015]. A su vez, la disponibilidad de alimento que proporcionan las plantas es fundamental para la subsistencia de los mamíferos herbívoros que habitan la selva. Los frutos, por su contenido nutricional y abundancia en ciertas épocas del año, constituyen un recurso clave para la fauna. Los mamíferos que consumen frutos pueden constituirse además, desde la perspectiva de las plantas, en dispersores o depredadores de semillas [@Muller-Landau2005]. A pesar de la importancia de esta interacción, hasta hace poco era sumamente difícil tener evidencia directa del consumo de frutos por mamíferos, en especial, de los terrestres medianos y grandes que son poco abundantes y/o difíciles de observar. Los estudios existentes se enfocan en especies particulares como los tapires [@OFarrill2013], los pecaríes [@Beck2006], el cerete (*Dasyprocta punctata*, [@Jansen2001]) o la paca (*Cuniculus paca*, [@Martinez-Cecenas2018]). Salvo algunas excepciones [@Donatti2011; @Eaton2017; @Vidal2013], hay pocos estudios a nivel comunitario.	Afortunadamente, las cámaras-trampa han permitido describir y analizar esta interacción con un detalle nunca antes visto.

El objetivo de este capítulo es ilustrar el proceso para analizar datos de fototrampeo generados para documentar las características de la interacción entre mamíferos terrestres y frutos en el piso de la selva. Este estudio de caso utiliza datos provenientes de cámaras-trampa que se instalaron en árboles en fructificación con el fin de determinar la composición de la comunidad de frugívoros visitantes y la intensidad de la interacción con los frutos del sonzapote (*Licania platypus*) y el mamey (*Pouteria sapota*).

En este ejemplo, nos basaremos en los datos del estudio de Camargo-Sanabria y Mendoza [-@Camargo-Sanabria2016] realizado en la Reserva de la Biósfera Montes Azules, Chiapas, México. En dicho estudio se colocaron cámaras-trampa en la base de árboles en fructificación dirigidas a los frutos acumulados en el piso de la selva, con el fin de comparar la composición y la riqueza de especies de la comunidad de mamíferos asociada a dos especies de árboles: el sonzapote (*Licania platypus*) y el mamey (*Pouteria sapota*). Específicamente, usaremos los datos de la comunidad de mamíferos registrada en la base de seis árboles (en adelante, árboles focales) del sonzapote y cuatro árboles del mamey en la temporada de fructificación de 2014 (Fig. \ref{foto}). 

Partiremos de una base de datos obtenida usando el programa especializado `Camera Base v1.5.1` [@Tobler2010]. Ésta será importada a R e iniciaremos el proceso de análisis aplicando una función para calcular tiempos de independencia especie-específicos (etapa 1). A continuación, usaremos estos tiempos para obtener una nueva base de datos en la que se identificarán los eventos independientes (etapa 2). Paso seguido, utilizaremos los eventos independientes y el esfuerzo de muestreo para calcular la frecuencia de captura (etapa 3.0). Con la misma base obtenida en la etapa 2, calcularemos la duración promedio de la visita (etapa 3.1) y la moda en el número de individuos (etapa 3.2) para cada especie animal en cada árbol focal. Finalmente, conjugaremos las tres variables evaluadas en la etapa 3 en un índice multiplicativo. El índice de fuerza de la interacción (IFI), calculado por especie de mamífero (etapa 4), será usado para describir visualmente cómo varía la interacción entre mamíferos y los frutos de las dos especies de árboles.

```{r foto, fig.pos = "H", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Mamíferos registrados interactuando con los frutos de *L. platypus* y *P. sapota* en el piso de la selva durante la temporada de fructificación de 2014 en la Reserva de la Biósfera Montes Azules.\\label{foto}", fig.align='center', out.width="95%"}
knitr::include_graphics("/Users/SMandujanoR/Documents/LaTex/Libros/ebook Foto-trampeo/Libro/Vol I/Cap_Angela/Fig1.jpg", dpi = 300)
```

El flujo de trabajo propuesto en este capítulo para el análisis de datos de interacciones fruto-mamífero también puede ser utilizado, con ciertas modificaciones, para describir y analizar otro tipo de interacciones en las que participan los mamíferos e incluso los patrones de uso de recursos abióticos como pueden ser las fuentes de agua (ver Delgado-Martínez et al. [-@Delgado-Martinez2018]). 

## Paquetes empleados

En este capítulo se emplean los siguientes paquetes:

- `data.table`
- `tidyverse`
- `reshape2`
- `dplyr`

Además, se usan funciones específicas creadas por los autores para cumplir los objetivos del análisis.

## ETAPA 1. Base de datos y tiempos de independencia

### Importación de datos

El primer paso es importar la base que contiene los registros de fototrampeo. Examinamos las primeras seis filas de la base:

```{r echo=TRUE, message=FALSE, warning=FALSE, linewidth=55}
BASE <- read.csv("base_trabajo.csv", row.names = 1)
head (BASE)
```

Se trata de una base de 1875 registros (filas) y 12 variables (columnas) y una riqueza de 13 especies de mamíferos. Otros atributos de la base se pueden explorar rápidamente con la función `str ()`.

Es fundamental resaltar que **las variables deben tener exactamente el mismo nombre del ejemplo** para que las funciones creadas corran sin problemas. A continuación, explicamos el contenido de cada columna:

1. `$SpeciesTree`: corresponde al nombre de la especie de árbol.
2. `$StationID`: corresponde al nombre de la estación de fototrampeo donde se generó el registro. En nuestro caso, corresponde a cada uno de los árboles focales.
3. `$SpeciesID`: corresponde al nombre de la especie de mamífero identificada en la foto.
4. `$Individuals`: corresponde al número de individuos observados en cada foto.
5. `$Date`: corresponde a la fecha en la que se generó el registro. El formato debe ser **dd/mm/aaaa**.
6. `$Time`: corresponde a la hora en la que se generó el registro. El formato debe ser **h:m:s**, aunque también se pueden omitir los segundos **h:m**.

Para utilizar las funciones que creamos, la base de datos debe estar organizada exactamente según esta secuencia: `SpeciesTree/StationID/SpeciesID/Date/Time`.

### Cálculo de independencia

Los estudios de foto-trampeo usualmente usan intervalos de 1, 12 o 24 horas para agrupar registros en eventos independientes, esto se hace con el fin de evitar la sobreestimación de la actividad animal o de la abundancia relativa [@Burton2015]. Sin embargo, estos intervalos de tiempo son utilizados en estudios a nivel comunitario, aun cuando se trate de especies con comportamientos muy diferentes. Para tratar de asignar un tiempo a cada especie de una forma más objetiva, creamos una rutina que agrupa los registros de una especie usando periodos que se incrementan de 1 a 1440 minutos (24 h). 

La función `calculate_indep` genera una gráfica del número de eventos independientes en función del periodo. El tiempo mínimo en el cual se estabiliza la curva, es decir, cuando el número de eventos independientes permanece sin cambios, se identifica como el periodo para agrupar los registros de cada especie animal en cada especie de árbol. Sólo calculamos este tiempo de independencia para las especies que tienen mínimo 10 registros en nuestra base de datos. Para las especies que no alcanzaron los 10 registros se utilizó un tiempo mínimo estándar.

Para poder utilizar la función `calculate_indep` es necesario contar con un subconjunto de `BASE` en el que sólo se tengan los registros de la especie *i*. Para automatizar este proceso, creamos la función `subset_10_registers`, la cual identifica las especies que tienen más de 10 registros y genera su respectiva base de datos. El resultado (`output`) de esta función es una lista que contiene los marcos de datos (`dataframes`) de las especies que cumplen el criterio de tener más de 10 registros.

Para utilizar la función `subset_10_registers` instalamos los paquetes `reshape2` y `tidyverse` y llamamos las funciones mediante la instrucción que se muestra a continuación.

```
install.packages("reshape2")
install.packages("tidyverse")
```

```{r echo=T}
source("Funciones.R")
```

Ahora aplicamos la función `subset_10_registers`, la cual pide como argumento un marco de datos, en nuestro caso es `BASE`.

```{r echo=T, message=F, warning=F}
BASE_10 <- subset_10_registers(BASE)
# confirmamos que es una lista y que tiene 14 elementos:
class (BASE_10)
length (BASE_10) 
```

El objeto `BASE_10` contiene 14 elementos porque incluye 13 subconjuntos y un elemento final que es una tabla que contiene los nombres de las especies de árboles y de mamíferos para los cuales se crearon los subconjuntos. Sobre cada uno de los subconjuntos (elementos 1 a 13) aplicamos la función `calculate_indep`. Para poder utilizar esta función es necesario instalar el paquete `data.table`.

```
install.packages("data.table")
```

Aplicamos la función `calculate_indep` a cada uno de los elementos [1-13] del objeto `BASE_10`, excepto al último. La ejecución de esta función puede tardar unos minutos dependiendo de la memoria RAM del computador.

```{r echo=TRUE, message=F}
#En cada ocasión sustituimos el número entre [[]].
calculate_indep (BASE_10[[1]]) 
```

Para cada combinación de especie animal - especie de árbol, la función devuelve una gráfica y tres valores:

1. `$minimo`: corresponde al tiempo en minutos en el cual empieza la meseta más larga, es decir, el tiempo mínimo para que dos registros consecutivos de la especie sean considerados independientes.
2. `$records`: es el número total de registros de la especie.
3. `$grouped_records`: es el número de eventos independientes que se obtienen con el tiempo de independencia.

En este ejemplo vemos la gráfica para *Conepatus semistriatus* en el árbol de *Pouteria sapota*. En este caso se encontró que un tiempo mínimo de 350 minutos es suficiente para separar los registros consecutivos de la especie en eventos independientes. 

Creamos el vector `TiempoInd` con los tiempos mínimos encontrados para cada especie. Luego construimos y exportamos un marco de datos (Cuadro \ref{tablaST}) con tres columnas: nombre de la especie del árbol, nombre de la especie de mamífero y tiempo de independencia en minutos. 

```{r, message=FALSE, warning=FALSE, eval=FALSE}
TiempoIndep <- c(350,248,85,300,592,475,178,31,42,325,
                 1,362,342)
TiempoIndep <- cbind (BASE_10[[14]], TiempoIndep)
print (TiempoIndep)
write.csv (TiempoIndep, "Species_times.csv")
```

\section[ETAPA 2. Generación de datos independientes]{ETAPA 2. Generación de datos \\ independientes} 

El siguiente paso es usar los tiempos de independencia generados anteriormente para identificar en nuestra base de trabajo los eventos independientes. Para esto usamos la función `analyze_times`, la cual genera una nueva base de datos a partir de `BASE` con una columna adicional en donde se identifican los eventos independientes. Esta función usa el tiempo de independencia calculado para cada especie de mamífero y en la nueva columna coloca un `TRUE` al primer registro del evento y un FALSE` a las filas siguientes.

La función `analyze_times` pide tres argumentos: el nombre de la base de trabajo `input_file`, el nombre de la base con los tiempos de independencia `times_file` y el nombre de la base que será generada `output_file`.

```{r eval=T, message = F, warning=F, echo=T}
BASE_ANALIZADA <- analyze_times("base_trabajo.csv",
            "Species_times.csv","base_analizada.csv")
```

Comprobamos que se genera una columna adicional llamada *Independ*.

```{r message=FALSE, warning=FALSE, linewidth=55}
head (BASE_ANALIZADA,10)
```

## ETAPA 3. Cálculo de la frecuencia de captura

La frecuencia de captura es una tasa que expresa el número de eventos independientes ponderado por el esfuerzo de muestreo. Se expresa como:
$$FC_i = \frac{No. Eventos_i}{EM} \times 100$$
donde: $No.Eventos_i$ es el número total de eventos independientes de la especie *i*; $EM$ es el esfuerzo de muestreo expresado en días cámara-trampa.

Para esta etapa necesitamos un archivo que contenga el esfuerzo de muestreo por árbol focal (Cuadro \ref{tablaEM}). 

```{r importar2, message=F, warning=F, include=FALSE}
em_station <- read.csv ("EM_station.csv", header = T)
```

```{r tablaEM, echo=F, message=F, warning=F}
library(kableExtra)
knitr::kable(em_station, booktabs = T, caption = "\\label{tablaEM}Datos del muestreo realizado en 10 árboles en fructificación durante 2014 en la Reserva de la Biósfera Montes Azules, Chiapas.", format = "latex") %>% kable_styling(font_size = 4.5) %>%
  kable_styling(latex_options = c("HOLD_position"))
```

La función `calculate_fc` automatiza el cálculo de la frecuencia de captura para cada especie de mamífero en cada árbol focal, y tiene como argumentos:

1. `input_file`: corresponde al archivo **.csv** de la base analizada obtenida en la **Etapa 2**.
2. `em_file`: corresponde al archivo **.csv** del esfuerzo de muestreo realizado en cada estación. Este archivo debe ser un marco de datos con una columna llamada *StationID* que contiene el nombre de las estaciones, los cuales deben ser idénticos a los usados en el objeto **BASE**, y una columna llamada *Dias* que contiene el esfuerzo de muestreo por estación. El marco de datos puede tener información adicional como las coordenadas de cada estación.
3. `output_file`: corresponde al archivo **.csv** que se va a exportar.
4. `n`: es un valor que se utiliza para estandarizar la frecuencia de captura, generalmente se usan 100 o 1000 días cámara-trampa. El valor por defecto es 100.
5. `melted`: este argumento permite definir si el resultado corresponderá a una matriz (`FALSE`) que puede ser utilizada en funciones como `metaMDS` del paquete `vegan`, o si el resultado es un marco de datos en formato largo (`TRUE`). El valor por defecto es TRUE.

Utilizamos la función `calculate_fc` para calcular la frecuencia de captura de cada especie de mamífero en cada árbol focal y revisamos las primeras 10 filas del nuevo objeto.

```{r message = FALSE}
FC <- calculate_fc("base_analizada.csv",
        "EM_Station.csv", "FC_result.csv", 
        melted = T)
head (FC, 10)
```

Los valores igual a "0" en la columna *FC* indican que esa especie no fue registrada en ese árbol focal.

### Duración promedio de la visita

En esta etapa usamos la función `calculate_visit` para calcular la duración promedio de la visita (= evento independiente) para cada especie de mamífero en cada árbol focal. La duración de la visita corresponde al tiempo, en minutos, transcurrido entre el primer (`TRUE`) y el último registro (`FALSE`) del evento.

Aplicamos la función `calculate_visit` cuyos argumentos son el nombre de la base analizada obtenida en la etapa 2 y el nombre del archivo de salida. Observamos las primeras 10 filas del objeto creado.

```{r message = FALSE}
DURATION_VISIT <- calculate_visit ("base_analizada.csv",
                    "Duration_result.csv")
head (DURATION_VISIT, 10)
```

### Cálculo de la moda 

En esta etapa usamos la función `calculate_mode_indiv` para calcular el promedio de la moda del número de individuos de cada especie de mamífero que se observaron en cada árbol focal. Primero se calcula la moda para cada evento independiente y luego el promedio para el árbol focal.

Aplicamos la función `calculate_mode_indiv` cuyos argumentos son el nombre de la base analizada obtenida en la etapa 2 y el nombre del archivo de salida. Observamos las primeras 10 filas del objeto creado.

```{r message = FALSE}
MODE_INDIVIDUALS <- calculate_mode_indiv(
  "base_analizada.csv", "Mode_indiv_result.csv")
head (MODE_INDIVIDUALS, 10)
```

\section[ETAPA 4. Cálculo de índice de fuerza de la interacción]{ETAPA 4. Cálculo de índice de \\ fuerza de la interacción} 

Recordemos que el objetivo del flujo de trabajo que hemos presentado hasta el momento es obtener variables cuantitativas que combinadas, nos permitan describir la interacción entre mamíferos terrestres y frutos de dos especies de árboles. El índice de fuerza de la interacción (IFI) se calcula para cada especie animal en cada especie de árbol y se expresa como: $IFI = FC * DV * MI$; donde: $FC$ es la frecuencia de captura, $DV$ es la duración promedio de la visita y $MI$ es la moda promedio en el número de individuos. Estos valores se encuentran almacenados en los objetos: `FC`, `DURATION_VISIT` y `MODE_INDIVIDUALS`, respectivamente. 
Creamos un marco de datos con las variables arriba indicadas y calculamos el índice promedio por especie de mamífero en cada especie de árbol. Este índice es adimensional y puede tener valores entre 0 e $\infty$. Para estandarizar los valores del IFI dividimos cada valor entre el máximo registrado en cada especie de árbol. De esta forma, los valores finales oscilan entre 0 y 1 (Cuadro \ref{tablaIFI}). Las siguientes líneas necesitan la instalación del paquete `dplyr`.

```
install.packages("dplyr")
```

```{r ifi, message = FALSE}
library(dplyr)

# Crear marco de datos con las tres variables
total_data <- full_join(FC, DURATION_VISIT,
            by = c("StationID", "SpeciesID")) %>%
  full_join(MODE_INDIVIDUALS, 
            by = c("StationID", "SpeciesID")) %>%
  full_join(em_station[,c("SpeciesTree",
                "StationID")], by="StationID")

# Calcular índice multiplicativo y guardarlo en 
# columna adicional
total_data$ifi <- with (total_data, 
                FC*mean_duration*mode_individuals)

# Obtener índice promedio por especie de mamífero y 
# especie de árbol
IFI_mean <- with (total_data, round(tapply (ifi, 
        list(SpeciesID, SpeciesTree), mean),2))

# Obtener índice estandarizado
IFI_mean_stand <- round (IFI_mean/rep (apply (IFI_mean, 
          2, max), each = dim (IFI_mean)[1]),2)
```

```{r tablaIFI, echo=F, message=F, warning=F, results='asis'}
library (kableExtra)
library (xtable)
knitr::kable(IFI_mean_stand, booktabs = T, caption = "\\label{tablaIFI}Índice de fuerza de la interacción estandarizado entre mamíferos terrestres y frutos de *Licania platypus* y *Pouteria sapota* durante 2014 en la Reserva de la Biósfera Montes Azules.", format = "latex") %>% kable_styling(font_size = 8) %>%
  kable_styling(latex_options = c("HOLD_position"))
```


El índice calculado se puede utilizar para mostrar gráficamente cómo varía la intensidad de la interacción entre especies de mamíferos en una especie de árbol y entre especies de árboles para un mismo mamífero (Fig. \ref{esquema}). Por ejemplo, el índice para *T. bairdii* en *P. sapota* (`r IFI_mean_stand[13,2]`) es 2.4 veces mayor que en *L. platypus* (`r IFI_mean_stand[13,1]`), indicando que la actividad de este mamífero es mayor en la primera especie de árbol y probablemente que hay algún proceso de selección de este recurso sobre otros disponibles. 

Vale la pena aclarar que en esta figura sólo aparecen las especies que interactuaron directamente con los frutos, es decir, aquellas que consumieron frutos *in situ* o los removieron fuera del área de detección de la cámara.

```{r esquema, fig.pos = "H", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Ensamble de mamíferos interactuando con los frutos de *Licania platypus* (arriba) y *Pouteria sapota* (abajo). Las flechas indican la intensidad de la interacción (IFI). Abreviatura: Cose = *Conepatus semistriatus*, Cupa = *Cuniculus paca*, Dapu = *Dasyprocta punctata*, Dima = *Didelphis marsupialis*, Eiba = *Eira barbara*, Nana = *Nasua narica*, Peta = *Pecari tajacu*, Taba = *Tapirus bairdii*.\\label{esquema}", fig.align='center', out.width="95%", results='asis'}
knitr::include_graphics("/Users/SMandujanoR/Documents/LaTex/Libros/ebook Foto-trampeo/Libro/Vol I/Cap_Angela/Fig.3.jpg")
```

## Sumario

El flujo de análisis desarrollado en este capítulo permitió ilustrar el potencial que tienen los datos de fototrampeo para describir y caracterizar las interacciones entre plantas y mamíferos, en particular, de aquellos diseños de muestreo en los que las cámaras son colocadas de manera oportunista frente a lo que se considera un recurso o atrayente para el animal. La sintaxis de las funciones propuestas aquí puede ser modificada para cumplir otras necesidades de análisis. Por ejemplo, estas funciones se pueden utilizar para comparar las interacciones planta - mamífero en sitios conservados vs. perturbados. En tal caso, las funciones tienen que ser modificadas para incluir la variable "Estado de conservación". De forma similar, este flujo de trabajo puede adaptarse al análisis de datos provenientes de cámaras-trampa instaladas para registrar la actividad de mamíferos que usan otro tipo de recursos como fuentes de agua, abrevaderos, saladeros, entre otros.



